# **锦麒行校园导游双平台系统需求文档**  
**版本**：2.0  
**发布日期**：待定  
**许可证**：GNU GPLv3  

---

## **一、项目概述**
### 1.1 背景与目标
| 属性 | 说明 |
|------|------|
| **背景** | 旅游高峰期高校游客管理困难，学生缺乏灵活创收渠道，游客缺乏深度文化体验。 |
| **目标** | 构建双平台系统：<br>- **总平台**：聚合服务、抽佣盈利<br>- **子平台**：开源供高校自主运营，支持本地化盈利 |
| **用户群体** | 游客、学生导游、高校运营团队、平台管理员 |

### 1.2 系统架构图
```plaintext
                +-------------------+       +-------------------+
                |   总平台          |       |   高校子平台      |
                | (JQX Hub)         |<----->| (JQX Campus)   |
                +-------------------+       +-------------------+
                       ^                            ^
                       |                            |
                +------+------+             +-------+-------+
                |  游客客户端 |             | 学生导游客户端 |
                +-------------+             +---------------+
```

---

## **二、核心功能需求**
### 2.1 总平台（JQX Hub）
#### 2.1.1 服务聚合与推荐
| 功能 | 详细规则 |
|------|----------|
| 服务展示 | 按地理位置排序，优先显示3km内导游，支持筛选（价格/评分/标签） |
| 智能推荐 | 基于用户行为推荐：带小孩游客→推荐“亲子友好”标签导游 |
| 抢单广播 | 实时推送新订单至符合时间条件的导游，延迟<1秒 |

#### 2.1.2 支付与分账
| 流程 | 规则 |
|------|------|
| 分账比例 | 总平台固定抽佣10%，剩余90%实时转入子平台账户 |
| 退款规则 | 服务开始前24小时可全额退款，超时仅退50% |

### 2.2 子平台（JQX Campus）
#### 2.2.1 导游时间管理
| 操作 | 规则 |
|------|------|
| 时间槽设置 | 最小单位30分钟，单次最多设置7天，支持批量勾选 |
| 冲突检测 | 若新订单与已有订单重叠，自动弹窗提示 |
| 临时关闭 | 可关闭未来72小时内任意时间段，已接订单不受影响 |

#### 2.2.2 订单匹配模式
| 模式 | 流程 |
|------|------|
| 指定导游 | 游客选择导游→查看可约时间→下单支付 |
| 智能派单 | 游客提交需求→系统推荐3人→游客选择→支付 |
| 抢单模式 | 游客发布需求→导游抢单→游客确认→支付 |

#### 2.2.3 导游个人主页
| 模块 | 元素 |
|------|------|
| 多媒体 | 最多上传3段视频（≤30秒）、6张图片（比例4:3） |
| 评价系统 | 差评需人工审核，敏感词自动过滤（如“诈骗”“骚扰”） |

---

## **三、系统交互设计**
### 3.1 关键业务流程
#### 3.1.1 抢单流程时序图
```plaintext
1. 游客发布需求（时间+偏好）
2. 总平台广播需求至匹配导游
3. 导游A在5秒内抢单
4. 系统锁定订单10分钟等待游客确认
5. 游客支付后订单生效
```

#### 3.1.2 时间冲突校验逻辑
```python
# 伪代码：检测时间是否可用
def is_time_available(guide_id, new_start, new_end):
    existing_orders = Order.objects.filter(
        guide_id=guide_id,
        status__in=["pending", "confirmed"],
        start__lt=new_end, 
        end__gt=new_start
    )
    return not existing_orders.exists()
```

### 3.2 API接口规范
#### 3.2.1 服务同步接口
```plaintext
Endpoint: POST /api/services/sync
Request:
{
  "campus_id": "WHU",
  "services": [
    {
      "id": "S001",
      "guide_id": "G123",
      "time_slots": ["2023-11-01T09:00:00", "2023-11-01T10:00:00"]
    }
  ]
}
Response:
{ "code": 200, "synced_count": 5 }
```

#### 3.2.2 支付回调接口
```plaintext
Endpoint: POST /api/payment/notify
Request: (微信支付标准回调参数)
Response: 
{ "code": 200, "order_id": "O20231001123456" }
```

---

## **四、数据设计**
### 4.1 核心数据表
#### 4.1.1 导游时间槽表 `guide_slots`
| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| guide_id | BIGINT | 关联导游ID |
| start_time | DATETIME | 开始时间（精确到分钟） |
| end_time | DATETIME | 结束时间 |
| status | ENUM('open','closed') | 状态 |

#### 4.1.2 订单表 `orders`
| 字段 | 类型 | 说明 |
|------|------|------|
| order_id | VARCHAR(32) | 订单号（规则：年月日+6位随机数） |
| total_fee | DECIMAL(10,2) | 总金额（单位：元） |
| commission | DECIMAL(10,2) | 平台佣金 |

### 4.2 数据流设计
```plaintext
游客下单 → 生成预支付订单 → 微信支付回调 → 分账至子平台 → 更新订单状态
```

---

## **五、非功能性需求**
### 5.1 性能指标
| 场景 | 要求 |
|------|------|
| 支付接口 | 响应时间≤800ms，99.9%请求成功率 |
| 抢单广播 | 从订单发布到导游接收≤500ms |
| 高并发 | 支持5000+同时在线用户 |

### 5.2 安全要求
| 领域 | 措施 |
|------|------|
| 支付安全 | 符合PCI DSS标准，敏感信息AES-256加密 |
| 内容安全 | 实时敏感词过滤（每秒扫描10万条消息） |
| 隐私保护 | 导游真实姓名默认脱敏（显示为“张*”） |

---

## **六、测试用例**
### 6.1 关键测试场景
| 测试项 | 预期结果 |
|------|------|
| 导游设置重叠时间 | 系统提示“时间冲突”且无法保存 |
| 多人同时抢单 | 仅第一个到达服务器的请求成功 |
| 分账金额计算 | 100元订单→总平台扣10元，子平台得90元 |

---

## **七、附录**
### 7.1 术语表
| 术语 | 解释 |
|------|------|
| SSO | 单点登录（如武大统一身份认证） |
| CPM | 广告计费模式（每千次展示成本） |

### 7.2 风险清单
1. 支付接口资质审核不通过 → 提前准备企业营业执照
2. 高校拒绝数据共享 → 提供数据隔离承诺书

### 8.api 文档

#### JQX Hub

需要处理游客注册，登录等
需要转发游客的订单请求至JQX Campus

#### JQX Campus

需要处理导游注册，登录，设置时间，抢单，订单管理等  
需要导游时间槽机制
需要查找功能
需要导游主页
需要评价功能